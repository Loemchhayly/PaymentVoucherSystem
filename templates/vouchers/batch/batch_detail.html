{% extends 'base.html' %}
{% load static %}

{% block title %}Batch {{ batch.batch_number }} - Details{% endblock %}

{% block content %}
<div class="container-fluid" style="max-width: 1400px; margin-top: -2.5rem;">
    <!-- Page Header -->
    <div class="page-header" style="margin-bottom: 2rem;">
        <div>
            <h1 style="font-size: 2rem; font-weight: 700; color: #1f2937; margin: 0;">
                <i class="bi bi-folder2-open" style="color: #667eea;"></i>
                {{ batch.batch_number }}
            </h1>
            <p style="color: #6b7280; margin-top: 0.5rem;">Batch Details</p>
        </div>
        <div style="display: flex; gap: 0.5rem;">
            {% if batch.status == 'PENDING' and batch.created_by == user %}
            <a href="{% url 'vouchers:batch_edit' batch.id %}" class="btn btn-primary">
                <i class="bi bi-pencil"></i> Edit Batch
            </a>
            <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteBatchModal">
                <i class="bi bi-trash"></i> Delete Batch
            </button>
            {% endif %}
            {% if document_count > 0 %}
            <a href="{% url 'vouchers:batch_export_excel' batch.id %}" class="btn btn-success">
                <i class="bi bi-file-earmark-excel"></i> Export to Excel
            </a>
            {% endif %}
            {% if user.role_level == 5 %}
            <a href="{% url 'vouchers:md_dashboard' %}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Back to MD Dashboard
            </a>
            {% else %}
            <a href="{% url 'dashboard:home' %}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Back to Dashboard
            </a>
            {% endif %}
        </div>
    </div>

    {% if document_count == 0 %}
    <!-- Warning for Empty Batch -->
    <div class="alert alert-danger" style="margin-bottom: 1.5rem; border-left: 4px solid #dc3545;">
        <h4 style="margin: 0 0 0.5rem 0;"><i class="bi bi-exclamation-triangle"></i> Empty Batch</h4>
        <p style="margin: 0;">This batch has no documents. Please add documents using the "Edit Batch" button or delete this batch.</p>
    </div>
    {% endif %}

    <div class="row">
        <!-- Batch Information Card -->
        <div class="col-lg-4 mb-4">
            <div class="card" style="border: 2px solid #e5e7eb;">
                <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
                    <h5 style="margin: 0;">
                        <i class="bi bi-info-circle"></i>
                        Batch Information
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Status -->
                    <div class="mb-3">
                        <small class="text-muted">Status</small>
                        <p style="margin: 0;">
                            {% if batch.status == 'PENDING' %}
                            <span class="badge bg-warning text-dark">PENDING</span>
                            {% elif batch.status == 'SIGNED' %}
                            <span class="badge bg-success">SIGNED</span>
                            {% elif batch.status == 'REJECTED' %}
                            <span class="badge bg-danger">REJECTED</span>
                            {% endif %}
                        </p>
                    </div>

                    <!-- Created By -->
                    <div class="mb-3">
                        <small class="text-muted">Created By</small>
                        <p style="margin: 0; font-weight: 600;">
                            {% if batch.created_by.get_full_name %}
                                {{ batch.created_by.get_full_name }}
                            {% else %}
                                {{ batch.created_by.username }}
                            {% endif %}
                        </p>
                        <small>{{ batch.created_at|date:"M d, Y H:i" }}</small>
                    </div>

                    <!-- Document Count -->
                    <div class="mb-3">
                        <small class="text-muted">Total Documents</small>
                        <p style="margin: 0;">
                            <span class="badge bg-primary" style="font-size: 1.1rem;">{{ document_count }}</span>
                        </p>
                    </div>

                    <!-- Total Amount -->
                    <div class="mb-3" style="padding: 1rem; background: #f0fdf4; border-left: 4px solid #10b981; border-radius: 0.25rem;">
                        <small class="text-muted">Total Amount</small>
                        <p style="margin: 0; font-size: 1.5rem; font-weight: 700; color: #10b981;">
                            {{ total_amount_display }}
                        </p>
                    </div>

                    <!-- FM Notes -->
                    {% if batch.fm_notes %}
                    <div class="mb-3">
                        <small class="text-muted">Finance Manager Notes</small>
                        <p style="margin: 0.5rem 0 0 0; padding: 0.75rem; background: #fef3c7; border-left: 3px solid #f59e0b; font-size: 0.9rem; border-radius: 0.25rem;">
                            {{ batch.fm_notes }}
                        </p>
                    </div>
                    {% endif %}

                    <!-- Signed Information -->
                    {% if batch.status == 'SIGNED' %}
                    <div class="mt-4 pt-3" style="border-top: 2px solid #e5e7eb;">
                        <small class="text-muted">Signed By</small>
                        <p style="margin: 0; font-weight: 600;">
                            {% if batch.signed_by.get_full_name %}
                                {{ batch.signed_by.get_full_name }}
                            {% else %}
                                {{ batch.signed_by.username }}
                            {% endif %}
                        </p>
                        <small>{{ batch.signed_at|date:"M d, Y H:i" }}</small>
                        {% if batch.signature_ip %}
                        <br><small class="text-muted">IP: {{ batch.signature_ip }}</small>
                        {% endif %}
                    </div>
                    {% endif %}

                    <!-- MD Comments -->
                    {% if batch.md_comments %}
                    <div class="mt-3">
                        <small class="text-muted">MD Comments</small>
                        <p style="margin: 0.5rem 0 0 0; padding: 0.75rem; background: #e0e7ff; border-left: 3px solid #667eea; font-size: 0.9rem; border-radius: 0.25rem;">
                            {{ batch.md_comments }}
                        </p>
                    </div>
                    {% endif %}

                    <!-- Actions (for MD only if pending) -->
                    {% if user.role_level == 5 and batch.status == 'PENDING' %}
                    <div class="mt-4 d-grid gap-2">
                        <button type="button" class="btn btn-success" onclick="showSignModal()">
                            <i class="bi bi-check-circle"></i> Sign All Documents
                        </button>
                        <button type="button" class="btn btn-outline-danger" onclick="showRejectModal()">
                            <i class="bi bi-x-circle"></i> Reject Batch
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Documents List -->
        <div class="col-lg-8 mb-4">
            <div class="card" style="border: 2px solid #e5e7eb;">
                <div class="card-header" style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                    <h5 style="margin: 0; color: #1f2937;">
                        <i class="bi bi-file-earmark-text"></i>
                        Documents in Batch ({{ document_count }})
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Payment Vouchers -->
                    {% if batch.voucher_items.all %}
                    <h6 style="color: #667eea; margin-bottom: 1rem;">
                        <i class="bi bi-receipt"></i>
                        Payment Vouchers ({{ batch.voucher_items.count }})
                    </h6>
                    <div class="table-container mb-4">
                        <table class="table table-hover batch-table">
                            <thead style="background: #f9fafb;">
                                <tr>
                                    <th style="width: 12%;">PV Number</th>
                                    <th style="width: 15%;">Payee</th>
                                    <th style="width: 20%;">Description</th>
                                    <th style="width: 13%;">Payment Date</th>
                                    <th style="width: 20%;">Transfer Account</th>
                                    <th style="width: 12%;">Amount</th>
                                    <th style="width: 8%;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in batch.voucher_items.all %}
                                <tr class="clickable-row" onclick="window.open('{% url 'vouchers:detail' item.voucher.id %}', '_blank')">
                                    <td style="white-space: nowrap;">
                                        <strong>{{ item.voucher.pv_number }}</strong>
                                    </td>
                                    <td>{{ item.voucher.payee_name }}</td>
                                    <td>
                                        {% for line_item in item.voucher.line_items.all %}
                                            {{ line_item.description }}{% if not forloop.last %}<br>{% endif %}
                                        {% empty %}
                                            <small class="text-muted">No description</small>
                                        {% endfor %}
                                    </td>
                                    <td>{{ item.voucher.payment_date|date:"M d, Y" }}</td>
                                    <td>
                                        {% if item.voucher.company_bank_account %}
                                            <div style="line-height: 1.4;">
                                                <strong style="color: #667eea;">{{ item.voucher.company_bank_account.bank }}</strong>
                                                <br><small style="color: #6b7280;">{{ item.voucher.company_bank_account.company_name }}</small>
                                                <br><small style="color: #9ca3af;">Acc: {{ item.voucher.company_bank_account.account_number }}</small>
                                            </div>
                                        {% else %}
                                            <small class="text-muted">
                                                {% if item.voucher.bank_address %}
                                                    {{ item.voucher.bank_address }}
                                                {% else %}
                                                    Not specified
                                                {% endif %}
                                            </small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <strong style="color: #10b981;">
                                            {{ item.voucher.get_grand_total_display }}
                                        </strong>
                                    </td>
                                    <td>
                                        {% if user.role_level == 5 and batch.status == 'PENDING' %}
                                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); showRemoveModal('voucher', {{ item.voucher.id }}, '{{ item.voucher.pv_number }}')">
                                            <i class="bi bi-x-circle"></i>
                                        </button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}

                    <!-- Payment Forms -->
                    {% if batch.form_items.all %}
                    <h6 style="color: #10b981; margin-bottom: 1rem;">
                        <i class="bi bi-file-text"></i>
                        Payment Forms ({{ batch.form_items.count }})
                    </h6>
                    <div class="table-container">
                        <table class="table table-hover batch-table">
                            <thead style="background: #f9fafb;">
                                <tr>
                                    <th style="width: 12%;">PF Number</th>
                                    <th style="width: 15%;">Payee</th>
                                    <th style="width: 20%;">Description</th>
                                    <th style="width: 13%;">Payment Date</th>
                                    <th style="width: 20%;">Transfer Account</th>
                                    <th style="width: 12%;">Amount</th>
                                    <th style="width: 8%;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in batch.form_items.all %}
                                <tr class="clickable-row" onclick="window.open('{% url 'vouchers:pf_detail' item.payment_form.id %}', '_blank')">
                                    <td style="white-space: nowrap;">
                                        <strong>{{ item.payment_form.pf_number }}</strong>
                                    </td>
                                    <td>{{ item.payment_form.payee_name }}</td>
                                    <td>
                                        {% for line_item in item.payment_form.line_items.all %}
                                            {{ line_item.description }}{% if not forloop.last %}<br>{% endif %}
                                        {% empty %}
                                            <small class="text-muted">No description</small>
                                        {% endfor %}
                                    </td>
                                    <td>{{ item.payment_form.payment_date|date:"M d, Y" }}</td>
                                    <td>
                                        {% if item.payment_form.company_bank_account %}
                                            <div style="line-height: 1.4;">
                                                <strong style="color: #667eea;">{{ item.payment_form.company_bank_account.bank }}</strong>
                                                <br><small style="color: #6b7280;">{{ item.payment_form.company_bank_account.company_name }}</small>
                                                <br><small style="color: #9ca3af;">Acc: {{ item.payment_form.company_bank_account.account_number }}</small>
                                            </div>
                                        {% else %}
                                            <small class="text-muted">
                                                {% if item.payment_form.bank_address %}
                                                    {{ item.payment_form.bank_address }}
                                                {% else %}
                                                    Not specified
                                                {% endif %}
                                            </small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <strong style="color: #10b981;">
                                            {{ item.payment_form.get_grand_total_display }}
                                        </strong>
                                    </td>
                                    <td>
                                        {% if user.role_level == 5 and batch.status == 'PENDING' %}
                                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); showRemoveModal('form', {{ item.payment_form.id }}, '{{ item.payment_form.pf_number }}')">
                                            <i class="bi bi-x-circle"></i>
                                        </button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}

                    <!-- Grand Total -->
                    <div class="mt-4 pt-3" style="border-top: 3px solid #667eea;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h5 style="margin: 0; color: #1f2937;">Grand Total:</h5>
                            <h4 id="grand-total-display" style="margin: 0; color: #10b981; font-weight: 700;">{{ total_amount_display }}</h4>
                        </div>
                        <div style="margin-top: 0.5rem;">
                            <small class="text-muted">Document Count: <span id="document-count-display">{{ document_count }}</span></small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sign Confirmation Modal -->
<div class="modal fade" id="signModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none;">
                <h5 class="modal-title">
                    <i class="bi bi-check-circle"></i>
                    Sign Batch
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    You are about to sign <strong>{{ document_count }} documents</strong> in batch <strong>{{ batch.batch_number }}</strong>.
                </div>
                <div class="mb-3">
                    <label class="form-label" style="font-weight: 600;">Comments (Optional)</label>
                    <textarea class="form-control" id="sign-comments" rows="3" placeholder="Add any comments or instructions..."></textarea>
                </div>
                <div class="alert alert-warning mb-0">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>This action cannot be undone.</strong> All documents in this batch will be marked as MD-approved.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="confirmSign()" id="sign-confirm-btn">
                    <i class="bi bi-pen"></i> Sign All Documents
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Reject Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none;">
                <h5 class="modal-title">
                    <i class="bi bi-x-circle"></i>
                    Reject Batch
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i>
                    You are about to reject batch <strong>{{ batch.batch_number }}</strong>.
                </div>
                <div class="mb-3">
                    <label class="form-label" style="font-weight: 600;">Rejection Reason <span class="text-danger">*</span></label>
                    <textarea class="form-control" id="reject-comments" rows="4" placeholder="Please provide a reason for rejection..." required></textarea>
                    <div class="invalid-feedback">
                        Please provide a rejection reason
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmReject()" id="reject-confirm-btn">
                    <i class="bi bi-x-circle"></i> Reject Batch
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Remove Document Modal -->
<div class="modal fade" id="removeDocModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none;">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle"></i>
                    Remove Document
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="bi bi-info-circle"></i>
                    You are about to remove document <strong id="remove-doc-number"></strong> from this batch.
                </div>
                <div class="mb-3">
                    <label class="form-label" style="font-weight: 600;">Reason for Removal <span class="text-danger">*</span></label>
                    <textarea class="form-control" id="remove-reason" rows="3" placeholder="Why are you removing this document?" required></textarea>
                    <div class="invalid-feedback">
                        Please provide a reason for removal
                    </div>
                </div>
                <div class="alert alert-info mb-0">
                    <small>
                        <i class="bi bi-lightbulb"></i>
                        <strong>Tip:</strong> The document will remain at PENDING_L5 status and can be added to another batch later.
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="confirmRemove()" id="remove-confirm-btn">
                    <i class="bi bi-x-circle"></i> Remove Document
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Check Bootstrap is loaded
function checkBootstrap() {
    if (typeof bootstrap === 'undefined') {
        console.error('Bootstrap is not loaded! Modals will not work.');
        return false;
    }
    return true;
}

function showSignModal() {
    try {
        if (!checkBootstrap()) {
            alert('System error: Page not fully loaded. Please refresh the page.');
            return;
        }
        const commentsField = document.getElementById('sign-comments');
        if (commentsField) {
            commentsField.value = '';
        }
        const modalElement = document.getElementById('signModal');
        if (modalElement) {
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        }
    } catch (error) {
        console.error('Error showing sign modal:', error);
        alert('Error: Could not open sign dialog. Please refresh the page.');
    }
}

function showRejectModal() {
    try {
        if (!checkBootstrap()) {
            alert('System error: Page not fully loaded. Please refresh the page.');
            return;
        }
        const commentsField = document.getElementById('reject-comments');
        if (commentsField) {
            commentsField.value = '';
        }
        const modalElement = document.getElementById('rejectModal');
        if (modalElement) {
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        }
    } catch (error) {
        console.error('Error showing reject modal:', error);
        alert('Error: Could not open reject dialog. Please refresh the page.');
    }
}

function confirmSign() {
    try {
        const btn = document.getElementById('sign-confirm-btn');
        const comments = document.getElementById('sign-comments').value;

        if (!btn) {
            console.error('Sign button not found');
            return;
        }

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Signing...';

        const formData = new FormData();
        formData.append('comments', comments);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        fetch('{% url "vouchers:batch_sign" batch.id %}', {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData,
            credentials: 'same-origin'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                if (checkBootstrap()) {
                    const modalElement = document.getElementById('signModal');
                    const modalInstance = bootstrap.Modal.getInstance(modalElement);
                    if (modalInstance) {
                        modalInstance.hide();
                    }
                }
                // Redirect - Django message will show
                window.location.href = data.redirect_url;
            } else {
                showToast('Error', data.error || 'Failed to sign batch', 'error');
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-pen"></i> Sign All Documents';
            }
        })
        .catch(error => {
            console.error('Sign error:', error);
            showToast('Error', 'Network error: ' + error.message, 'error');
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-pen"></i> Sign All Documents';
        });
    } catch (error) {
        console.error('Unexpected error in confirmSign:', error);
        alert('An unexpected error occurred. Please try again.');
    }
}

function confirmReject() {
    try {
        const btn = document.getElementById('reject-confirm-btn');
        const commentsField = document.getElementById('reject-comments');
        const comments = commentsField ? commentsField.value.trim() : '';

        if (!comments) {
            if (commentsField) {
                commentsField.classList.add('is-invalid');
            }
            return;
        }

        if (commentsField) {
            commentsField.classList.remove('is-invalid');
        }

        if (!btn) {
            console.error('Reject button not found');
            return;
        }

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Rejecting...';

        const formData = new FormData();
        formData.append('comments', comments);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        fetch('{% url "vouchers:batch_reject" batch.id %}', {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData,
            credentials: 'same-origin'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                if (checkBootstrap()) {
                    const modalElement = document.getElementById('rejectModal');
                    const modalInstance = bootstrap.Modal.getInstance(modalElement);
                    if (modalInstance) {
                        modalInstance.hide();
                    }
                }
                // Redirect - Django message will show
                window.location.href = data.redirect_url;
            } else {
                showToast('Error', data.error || 'Failed to reject batch', 'error');
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-x-circle"></i> Reject Batch';
            }
        })
        .catch(error => {
            console.error('Reject error:', error);
            showToast('Error', 'Network error: ' + error.message, 'error');
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-x-circle"></i> Reject Batch';
        });
    } catch (error) {
        console.error('Unexpected error in confirmReject:', error);
        alert('An unexpected error occurred. Please try again.');
    }
}

function showToast(title, message, type = 'info') {
    try {
        // Check if Bootstrap Toast is available
        if (typeof bootstrap !== 'undefined' && bootstrap.Toast) {
            // Escape HTML to prevent XSS
            const escapeHtml = (str) => {
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            };

            const safeTitle = escapeHtml(title);
            const safeMessage = escapeHtml(message);
            const bgClass = type === 'success' ? 'success' : type === 'error' ? 'danger' : type === 'warning' ? 'warning' : 'primary';

            // Create toast element
            const toastHtml = `
                <div class="toast align-items-center text-white bg-${bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            <strong>${safeTitle}</strong>
                            <br>${safeMessage}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;

            // Get or create toast container
            let toastContainer = document.querySelector('.toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
                toastContainer.style.zIndex = '9999';
                document.body.appendChild(toastContainer);
            }

            // Add toast to container
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            const toastElement = toastContainer.lastElementChild;
            const toast = new bootstrap.Toast(toastElement, {
                autohide: true,
                delay: 5000
            });
            toast.show();

            // Remove toast element after it's hidden
            toastElement.addEventListener('hidden.bs.toast', () => {
                toastElement.remove();
            });
        } else {
            // Fallback for browsers where Bootstrap is not loaded
            console.warn('Bootstrap not available, using alert fallback');
            const icon = type === 'success' ? '✓' : type === 'warning' ? '⚠' : type === 'error' ? '✗' : 'ℹ';
            alert(`${icon} ${title}\n${message}`);
        }
    } catch (error) {
        console.error('Error in showToast:', error);
        // Final fallback
        alert(`${title}\n${message}`);
    }
}

// Document Removal Functions
let currentRemoveDocType = null;
let currentRemoveDocId = null;

function showRemoveModal(docType, docId, docNumber) {
    try {
        if (!checkBootstrap()) {
            alert('System error: Page not fully loaded. Please refresh the page.');
            return;
        }

        currentRemoveDocType = docType;
        currentRemoveDocId = docId;

        const docNumberElement = document.getElementById('remove-doc-number');
        if (docNumberElement) {
            docNumberElement.textContent = docNumber;
        }

        const reasonField = document.getElementById('remove-reason');
        if (reasonField) {
            reasonField.value = '';
            reasonField.classList.remove('is-invalid');
        }

        const modalElement = document.getElementById('removeDocModal');
        if (modalElement) {
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        }
    } catch (error) {
        console.error('Error showing remove modal:', error);
        alert('Error: Could not open remove dialog. Please refresh the page.');
    }
}

function confirmRemove() {
    try {
        const reasonField = document.getElementById('remove-reason');
        const reason = reasonField ? reasonField.value.trim() : '';
        const btn = document.getElementById('remove-confirm-btn');

        if (!reason) {
            if (reasonField) {
                reasonField.classList.add('is-invalid');
            }
            return;
        }

        if (reasonField) {
            reasonField.classList.remove('is-invalid');
        }

        if (!btn) {
            console.error('Remove button not found');
            return;
        }

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Removing...';

        const formData = new FormData();
        formData.append('doc_type', currentRemoveDocType);
        formData.append('doc_id', currentRemoveDocId);
        formData.append('reason', reason);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        fetch('{% url "vouchers:batch_remove_document" batch.id %}', {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData,
            credentials: 'same-origin'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                if (checkBootstrap()) {
                    const modalElement = document.getElementById('removeDocModal');
                    const modalInstance = bootstrap.Modal.getInstance(modalElement);
                    if (modalInstance) {
                        modalInstance.hide();
                    }
                }

                if (data.batch_empty) {
                    showToast('Batch Empty', data.message, 'warning');
                    setTimeout(() => {
                        window.location.href = data.redirect_url;
                    }, 2000);
                } else {
                    showToast('Success', data.message, 'success');

                    // Update the totals (safely check if elements exist)
                    const totalElement = document.getElementById('grand-total-display');
                    const countElement = document.getElementById('document-count-display');

                    if (totalElement && data.new_total) {
                        totalElement.textContent = data.new_total;
                    }
                    if (countElement && data.new_count !== undefined) {
                        countElement.textContent = data.new_count;
                    }

                    // Reload page to update document list
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                }
            } else {
                showToast('Error', data.error || 'Failed to remove document', 'error');
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-x-circle"></i> Remove Document';
            }
        })
        .catch(error => {
            console.error('Remove document error:', error);
            showToast('Error', 'Network error: ' + error.message, 'error');
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-x-circle"></i> Remove Document';
        });
    } catch (error) {
        console.error('Unexpected error in confirmRemove:', error);
        alert('An unexpected error occurred. Please try again.');
    }
}

// Delete Batch
function deleteBatch() {
    try {
        fetch("{% url 'vouchers:batch_delete' batch.id %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json'
            },
            credentials: 'same-origin'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                window.location.href = data.redirect_url;
            } else {
                showToast('Error', data.error || 'Failed to delete batch', 'error');
            }
        })
        .catch(error => {
            console.error('Delete batch error:', error);
            showToast('Error', 'Network error: ' + error.message, 'error');
        });
    } catch (error) {
        console.error('Unexpected error in deleteBatch:', error);
        alert('An unexpected error occurred. Please try again.');
    }
}

// Check page is fully loaded on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('Batch detail page loaded');
    console.log('Bootstrap available:', typeof bootstrap !== 'undefined');
    console.log('jQuery available:', typeof $ !== 'undefined');

    // Verify critical elements exist
    const criticalElements = ['signModal', 'rejectModal', 'removeDocModal'];
    criticalElements.forEach(id => {
        const element = document.getElementById(id);
        if (!element) {
            console.warn(`Critical element missing: ${id}`);
        }
    });
});
</script>

<!-- Delete Batch Confirmation Modal -->
{% if batch.status == 'PENDING' and batch.created_by == user %}
<div class="modal fade" id="deleteBatchModal" tabindex="-1" aria-labelledby="deleteBatchModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%); color: white;">
                <h5 class="modal-title" id="deleteBatchModalLabel">
                    <i class="bi bi-trash"></i> Delete Batch
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; padding: 1rem;">
                    <i class="bi bi-exclamation-triangle" style="font-size: 4rem; color: #dc2626;"></i>
                    <h4 style="margin-top: 1rem; color: #1f2937;">Are you sure?</h4>
                    <p style="color: #6b7280; margin-top: 0.5rem;">
                        This will permanently delete batch <strong>{{ batch.batch_number }}</strong>.
                        <br>This action cannot be undone.
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x"></i> Cancel
                </button>
                <button type="button" class="btn btn-danger" onclick="deleteBatch()" data-bs-dismiss="modal">
                    <i class="bi bi-trash"></i> Yes, Delete Batch
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<style>
.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

/* Table Container - No scrollbars */
.table-container {
    width: 100%;
    overflow: visible;  /* No scrollbars */
    padding: 0;
}

.batch-table {
    width: 100%;
    table-layout: fixed;  /* Fixed layout prevents overflow */
}

/* Clickable Row Styles */
.batch-table .clickable-row {
    cursor: pointer;
    transition: all 0.2s ease;
}

.batch-table .clickable-row:hover {
    background: #f3f4f6 !important;
    transform: scale(1.001);  /* Reduced scale to prevent scrollbar */
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.batch-table .clickable-row:active {
    transform: scale(0.998);
}

/* Professional equal column widths */
.batch-table th,
.batch-table td {
    vertical-align: middle;
    padding: 0.75rem;
}

/* Remove button styling - compact and clean */
.batch-table .btn-outline-danger {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
    border-radius: 0.25rem;
    transition: all 0.2s ease;
}

.batch-table .btn-outline-danger:hover {
    transform: scale(1.05);
}

.batch-table .btn-outline-danger i {
    font-size: 1rem;
}

/* Smooth hover transitions for table */
.batch-table tbody tr {
    transition: all 0.2s ease;
}

/* Ensure text doesn't get selected when clicking rows */
.batch-table .clickable-row {
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}

/* Make sure buttons are still selectable */
.batch-table .clickable-row button {
    -webkit-user-select: auto;
    -moz-user-select: auto;
    -ms-user-select: auto;
    user-select: auto;
}

@media (max-width: 768px) {
    .page-header {
        flex-direction: column;
        align-items: flex-start;
    }

    .page-header > div:last-child {
        margin-top: 1rem;
    }

    /* Mobile table responsiveness with horizontal scroll when needed */
    .table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    /* Adjust table for mobile - make columns stack better */
    .batch-table th,
    .batch-table td {
        padding: 0.5rem;
        font-size: 0.875rem;
    }

    .batch-table .clickable-row:hover {
        transform: none; /* Disable transform on mobile for better touch interaction */
    }
}
</style>
{% endblock %}