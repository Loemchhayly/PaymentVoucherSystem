{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}{{ title }} - Payment Voucher System{% endblock %}

{% block extra_css %}
<style>
    /* ==================== COMPACT Form Specific Styles ==================== */
    .voucher-form-container {
        max-width: 1600px; /* CHANGED from 1200px to 1600px */
        margin: 0 auto;
        padding: 0 var(--spacing-md); /* CHANGED from var(--spacing-xl) to var(--spacing-md) */
        opacity: 0;
        animation: fadeInPage 0.5s ease-in 0.1s forwards;
    }

    @keyframes fadeInPage {
        to { opacity: 1; }
    }

    @keyframes fadeInUp {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @media (min-width: 1800px) {
        .voucher-form-container {
            max-width: 1800px;
            padding: 0 var(--spacing-lg);
        }
    }

    .page-header {
        margin-bottom: var(--spacing-md); /* ✅ REDUCED from 2xl to md */
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: var(--spacing-sm); /* ✅ REDUCED from md to sm */
    }

    .page-title {
        font-family: var(--font-heading);
        font-size: 1.5rem; /* ✅ REDUCED from 2rem */
        font-weight: 500;
        color: var(--gray-900);
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        margin-top: -20px; /* ✅ REDUCED from -30px */
    }

    .page-title i {
        font-size: 1.75rem; /* ✅ REDUCED from 2.5rem */
        background: linear-gradient(135deg, #10b981 0%, #059669 100%); /* Green gradient for PF */
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .form-card {
        background: white;
        border-radius: var(--radius-lg); /* ✅ REDUCED from xl */
        box-shadow: var(--shadow-sm); /* ✅ REDUCED from md */
        overflow: hidden;
        margin-bottom: var(--spacing-md); /* ✅ REDUCED from xl */
        transition: all var(--transition-base);
        opacity: 0;
        transform: translateY(15px); /* ✅ REDUCED from 20px */
        animation: fadeInUp 0.5s ease-out forwards;
        margin-top: -20px; /* ✅ REDUCED from -40px */
    }

    .form-card:nth-of-type(1) { animation-delay: 0.15s; }
    .form-card:nth-of-type(2) { animation-delay: 0.25s; }
    .form-card:nth-of-type(3) { animation-delay: 0.35s; }

    .form-card:hover {
        box-shadow: var(--shadow-lg);
    }

    .form-card-header {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%); /* Green for PF */
        padding: var(--spacing-sm) var(--spacing-md); /* ✅ REDUCED from lg/xl */
        border-bottom: 2px solid #34d399; /* ✅ REDUCED from 3px */
    }

    .form-card-header.info {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        border-bottom-color: #60a5fa;
    }

    .form-card-title {
        font-family: var(--font-heading);
        font-size: 1.25rem;
        font-weight: 600;
        color: white;
        margin: 0;
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    .form-card-title i {
        font-size: 1.5rem;
    }

    .form-card-body {
        padding: var(--spacing-lg) var(--spacing-xl); /* ✅ COMPACT padding */
    }

    .form-group {
        margin-bottom: var(--spacing-sm); /* ✅ REDUCED from lg */
    }

    /* ✅ 3-COLUMN GRID LAYOUT */
    .form-row {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-md);
    }

    .form-row .form-group {
        margin-bottom: 0;
    }

    .form-label {
        font-family: var(--font-body);
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--gray-700);
        margin-bottom: 4px; /* ✅ REDUCED from var(--spacing-sm) */
        display: block;
    }

    .form-control,
    .form-select {
        font-family: var(--font-body);
        font-size: 0.875rem; /* ✅ REDUCED from 0.9375rem */
        padding: 0.375rem 0.625rem; /* ✅ REDUCED from sm/md */
        border: 1px solid var(--gray-300); /* ✅ REDUCED from 2px */
        border-radius: var(--radius-sm); /* ✅ REDUCED from md */
        transition: all var(--transition-fast);
        background: white;
        height: 38px; /* ✅ Fixed height for consistency */
    }

    .form-control:focus,
    .form-select:focus {
        border-color: #10b981; /* Green for PF */
        box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.1); /* ✅ REDUCED from 3px */
        outline: none;
    }

    .form-control:hover,
    .form-select:hover {
        border-color: #34d399;
    }

    .line-items-table-container {
        overflow-x: auto;
        margin-bottom: var(--spacing-md);
    }

    .line-items-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        margin-bottom: var(--spacing-md);
    }

    .line-items-table thead {
        background: linear-gradient(135deg, var(--gray-50) 0%, #d1fae5 100%); /* Light green */
    }

    .line-items-table th {
        font-family: var(--font-body);
        font-size: 0.75rem; /* ✅ REDUCED from 0.8125rem */
        font-weight: 600;
        color: var(--gray-700);
        text-transform: uppercase;
        letter-spacing: 0.3px; /* ✅ REDUCED from 0.5px */
        padding: var(--spacing-sm); /* ✅ REDUCED from md */
        text-align: left;
        border-bottom: 2px solid #34d399;
        white-space: nowrap;
    }

    .line-items-table tbody tr {
        transition: all var(--transition-base);
    }

    .line-items-table tbody tr:hover {
        background: #d1fae5; /* Light green */
    }

    .line-item-row {
        transition: opacity 0.2s ease-out, transform 0.2s ease-out;
    }

    .line-items-table td {
        padding: 6px var(--spacing-sm); /* ✅ REDUCED vertical padding */
        border-bottom: 1px solid var(--gray-200);
        vertical-align: middle;
    }

    .line-items-table td input,
    .line-items-table td select,
    .line-items-table td textarea {
        width: 100%;
        font-size: 0.8125rem; /* ✅ REDUCED from 0.875rem */
        padding: 4px 8px; /* ✅ REDUCED from xs/sm */
        border: 1px solid var(--gray-300); /* ✅ REDUCED from 2px */
        border-radius: var(--radius-sm);
        transition: all var(--transition-fast);
    }

    .line-items-table td input:focus,
    .line-items-table td select:focus,
    .line-items-table td textarea:focus {
        border-color: #10b981;
        box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.1); /* ✅ REDUCED from 3px */
        outline: none;
    }

    .line-items-table td textarea {
        min-height: 50px; /* ✅ REDUCED from 60px */
        resize: vertical;
    }

    .line-items-table td input[type="hidden"] {
        display: none;
    }

    /* ✅ COMPACT Line Number Badge */
    .line-number-badge {
        display: inline-block;
        width: 28px; /* ✅ REDUCED from 32px */
        height: 28px; /* ✅ REDUCED from 32px */
        line-height: 28px;
        text-align: center;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%); /* Green for PF */
        color: white;
        border-radius: var(--radius-sm); /* ✅ REDUCED from md */
        font-weight: 700;
        font-size: 0.8125rem; /* ✅ REDUCED from 0.875rem */
    }

    .vat-checkbox-container {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .vat-checkbox {
        width: 20px; /* ✅ REDUCED from 24px */
        height: 20px; /* ✅ REDUCED from 24px */
        cursor: pointer;
        accent-color: #10b981; /* Green for PF */
    }

    .line-total {
        font-family: var(--font-heading);
        font-weight: 700;
        font-size: 1rem;
        color: var(--gray-900);
        text-align: right;
        white-space: nowrap;
    }

    .line-items-table tfoot {
        background: linear-gradient(135deg, #1666d8 0%, #1666d8 100%); /* Green for PF */
    }

    /* ✅ COMPACT Grand Total */
    .line-items-table tfoot th {
        color: white;
        font-size: 0.875rem; /* ✅ REDUCED from 1rem */
        padding: var(--spacing-sm); /* ✅ REDUCED from md */
        border: none;
    }

    .grand-total-value {
        font-family: var(--font-heading);
        font-size: 1.5rem;
        font-weight: 700;
        text-align: right;
    }

    .add-line-btn {
        background: white;
        color: #059669;
        border: 2px solid #10b981;
        border-radius: var(--radius-lg);
        padding: var(--spacing-sm) var(--spacing-lg);
        font-family: var(--font-body);
        font-weight: 600;
        font-size: 0.9375rem;
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-sm);
        transition: all var(--transition-base);
        cursor: pointer;
    }

    .add-line-btn:hover {
        background: #10b981;
        color: white;
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }

    .add-line-btn i {
        font-size: 1.25rem;
    }

    .delete-line-btn {
        background: transparent;
        color: var(--gray-500);
        border: none;
        padding: var(--spacing-xs);
        border-radius: var(--radius-sm);
        cursor: pointer;
        transition: all var(--transition-fast);
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .delete-line-btn:hover {
        background: rgba(239, 68, 68, 0.1);
        color: #dc2626;
        transform: scale(1.1);
    }

    .delete-line-btn i {
        font-size: 1.125rem;
    }

    .toast-notification {
        position: fixed;
        top: 80px;
        right: 20px;
        min-width: 300px;
        max-width: 400px;
        background: white;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-xl);
        padding: var(--spacing-md) var(--spacing-lg);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        z-index: 9999;
        animation: slideInRight 0.3s ease-out;
        border-left: 4px solid #10b981;
    }

    .toast-notification.success {
        border-left-color: var(--success);
    }

    .toast-notification.warning {
        border-left-color: var(--warning);
    }

    .toast-notification.danger {
        border-left-color: var(--danger);
    }

    .toast-notification i {
        font-size: 1.25rem;
        flex-shrink: 0;
    }

    .toast-notification.success i {
        color: var(--success);
    }

    .toast-notification.warning i {
        color: var(--warning);
    }

    .toast-notification.danger i {
        color: var(--danger);
    }

    .toast-notification .toast-message {
        flex: 1;
        font-family: var(--font-body);
        font-size: 0.9375rem;
        font-weight: 500;
        color: var(--gray-900);
    }

    .toast-notification.fadeOut {
        animation: fadeOut 0.3s ease-out forwards;
    }

    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @keyframes fadeOut {
        from {
            opacity: 1;
        }
        to {
            opacity: 0;
            transform: translateX(100%);
        }
    }

    .attachment-upload-area {
        margin-bottom: var(--spacing-md);
    }

    .attachment-upload-label {
        display: block;
        border: 2px dashed #34d399;
        border-radius: var(--radius-md); /* ✅ REDUCED from lg */
        padding: var(--spacing-md); /* ✅ REDUCED from 2xl */
        text-align: center;
        cursor: pointer;
        transition: all var(--transition-base);
        background: #d1fae5;
    }

    .attachment-upload-label:hover {
        border-color: #10b981;
        background: #a7f3d0;
        transform: translateY(-2px);
    }

    .attachment-input {
        display: none;
    }

    .upload-icon {
        font-size: 2rem; /* ✅ REDUCED from 3rem */
        color: #10b981;
        margin-bottom: 4px; /* ✅ REDUCED */
    }

    .upload-text {
        font-size: 0.875rem; /* ✅ REDUCED from 1rem */
        color: var(--gray-700);
        margin-bottom: 2px; /* ✅ REDUCED */
    }

    .upload-text strong {
        color: #059669;
    }

    .upload-hint {
        font-size: 0.75rem; /* ✅ REDUCED from 0.875rem */
        color: var(--gray-600);
    }

    .selected-files-list {
        background: var(--gray-50);
        border: 1px solid var(--gray-200);
        border-radius: var(--radius-sm); /* ✅ REDUCED from md */
        padding: var(--spacing-sm); /* ✅ REDUCED from md */
        margin-top: var(--spacing-sm); /* ✅ REDUCED from md */
    }

    .files-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .files-list li {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 6px var(--spacing-sm); /* ✅ REDUCED padding */
        background: white;
        border: 1px solid var(--gray-200);
        border-radius: var(--radius-sm);
        margin-bottom: 4px; /* ✅ REDUCED from xs */
        font-size: 0.8125rem; /* ✅ REDUCED from 0.875rem */
    }

    .files-list li:last-child {
        margin-bottom: 0;
    }

    .file-info {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        flex: 1;
    }

    .file-icon {
        color: #059669;
        font-size: 1.25rem;
    }

    .file-name {
        font-weight: 500;
        color: var(--gray-900);
    }

    .file-size {
        color: var(--gray-600);
        font-size: 0.8125rem;
        margin-left: var(--spacing-xs);
    }

    .remove-file-btn {
        background: var(--danger);
        color: white;
        border: none;
        border-radius: var(--radius-sm);
        padding: 4px 8px;
        font-size: 0.75rem;
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .remove-file-btn:hover {
        background: #b91c1c;
        transform: scale(1.05);
    }

    .action-buttons {
        display: flex;
        gap: var(--spacing-md);
        flex-wrap: wrap;
    }

    /* ⚡ INSTANT FEEDBACK: Loading overlay */
    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        z-index: 99999;
        align-items: center;
        justify-content: center;
    }

    .loading-overlay.active {
        display: flex;
    }

    .loading-spinner {
        background: white;
        padding: var(--spacing-2xl);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-2xl);
        text-align: center;
        min-width: 200px;
    }

    .loading-spinner i {
        font-size: 3rem;
        color: #10b981; /* Green for PF */
        animation: spin 0.8s linear infinite;
        display: block;
        margin-bottom: var(--spacing-md);
    }

    .loading-spinner p {
        margin: 0;
        font-size: 1rem;
        font-weight: 600;
        color: var(--gray-700);
    }

    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    .save-btn.submitting {
        opacity: 0.7;
        cursor: not-allowed;
        position: relative;
    }

    .save-btn.submitting::after {
        content: ' Saving...';
    }

    .save-btn {
        background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
        color: white;
        border: none;
        border-radius: var(--radius-md); /* ✅ REDUCED from lg */
        padding: var(--spacing-sm) var(--spacing-lg); /* ✅ REDUCED from md/2xl */
        font-family: var(--font-body);
        font-weight: 600;
        font-size: 0.9375rem; /* ✅ REDUCED from 1rem */
        display: inline-flex;
        align-items: center;
        gap: 6px; /* ✅ REDUCED from sm */
        transition: all var(--transition-base);
        box-shadow: var(--shadow-sm); /* ✅ REDUCED from md */
        cursor: pointer;
    }

    .save-btn:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow-lg);
        background: linear-gradient(135deg, #059669 0%, #047857 100%);
    }

    .save-btn i {
        font-size: 1.25rem;
    }

    .cancel-btn {
        background: white;
        color: var(--gray-700);
        border: 2px solid var(--gray-300);
        border-radius: var(--radius-md); /* ✅ REDUCED from lg */
        padding: var(--spacing-sm) var(--spacing-lg); /* ✅ REDUCED from md/2xl */
        font-family: var(--font-body);
        font-weight: 600;
        font-size: 0.9375rem; /* ✅ REDUCED from 1rem */
        display: inline-flex;
        align-items: center;
        gap: 6px; /* ✅ REDUCED from sm */
        text-decoration: none;
        transition: all var(--transition-base);
    }

    .cancel-btn:hover {
        background: var(--gray-50);
        border-color: var(--gray-400);
        color: var(--gray-900);
        transform: translateY(-2px);
    }

    .cancel-btn i {
        font-size: 1.25rem;
    }

    /* ✅ COMPACT Helper Text */
    .helper-text {
        font-size: 0.75rem; /* ✅ REDUCED from 0.8125rem */
        color: var(--gray-600);
        margin-top: 6px; /* ✅ REDUCED from var(--spacing-xs) */
        display: flex;
        align-items: center;
        gap: 4px; /* ✅ REDUCED from var(--spacing-xs) */
    }

    .helper-text i {
        color: #10b981;
        font-size: 0.875rem; /* ✅ Slightly smaller icon */
    }

    /* RESPONSIVE DESIGN */
    @media (max-width: 1200px) {
        .form-row {
            grid-template-columns: repeat(2, 1fr); /* ✅ 2 columns on tablets */
        }
    }

    @media (max-width: 991px) {
        .voucher-form-container {
            padding: 0 var(--spacing-md);
        }

        .page-title {
            font-size: 1.5rem; /* ✅ Already compact */
        }

        .form-card-body {
            padding: var(--spacing-md);
        }

        .form-row {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 768px) {
        .voucher-form-container {
            padding: 0 12px;
        }

        .page-header {
            flex-direction: column;
            align-items: flex-start;
        }

        .page-title {
            font-size: 1.25rem; /* ✅ Even smaller on mobile */
        }

        .page-title i {
            font-size: 1.5rem;
        }

        .form-card-header,
        .form-card-body {
            padding: var(--spacing-sm) var(--spacing-md);
        }

        .form-row {
            grid-template-columns: 1fr !important; /* ✅ Single column on mobile */
            gap: var(--spacing-sm);
        }

        .form-group {
            margin-bottom: var(--spacing-md);
        }

        .line-items-table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin: 0 -12px;
            padding: 0 12px;
        }

        .line-items-table {
            min-width: 800px;
            font-size: 0.8125rem;
        }

        .line-items-table th,
        .line-items-table td {
            padding: var(--spacing-xs) var(--spacing-sm);
        }

        .attachment-upload-label {
            padding: var(--spacing-lg);
        }

        .upload-icon {
            font-size: 2rem;
        }

        .upload-text {
            font-size: 0.875rem;
        }

        .upload-hint {
            font-size: 0.75rem;
        }

        .action-buttons {
            flex-direction: column;
            width: 100%;
        }

        .save-btn,
        .cancel-btn,
        .add-line-btn,
        .delete-line-btn {
            width: 100%;
            justify-content: center;
            min-height: 44px;
        }

        .toast-notification {
            right: 10px;
            left: 10px;
            top: 70px;
            min-width: auto;
            max-width: none;
        }
    }

    @media (max-width: 576px) {
        .voucher-form-container {
            padding: 0 8px;
        }

        .page-title {
            font-size: 1.25rem;
        }

        .form-card-header h3 {
            font-size: 1rem;
        }

        .line-items-table {
            font-size: 0.75rem;
            min-width: 700px;
        }

        .line-items-table th,
        .line-items-table td {
            padding: var(--spacing-xs);
        }

        .grand-total {
            font-size: 1.25rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="voucher-form-container">
    <!-- Page Header -->
    <div class="page-header">
        <h1 class="page-title">
            <i class="bi bi-file-earmark-text"></i>
            <span>{{ title }}</span>
        </h1>
    </div>

    <!-- Debug: Show all errors -->
    {% if form.errors or formset.errors or formset.non_form_errors %}
    <div class="alert alert-danger" style="margin-bottom: var(--spacing-xl);">
        <h4><i class="bi bi-exclamation-triangle-fill"></i> Form Validation Errors:</h4>
        {% if form.errors %}
            <strong>Header Form Errors:</strong>
            <ul>
            {% for field, errors in form.errors.items %}
                <li><strong>{{ field }}:</strong> {{ errors|join:", " }}</li>
            {% endfor %}
            </ul>
        {% endif %}
        {% if formset.non_form_errors %}
            <strong>Line Items General Errors:</strong>
            <ul>
                <li>{{ formset.non_form_errors }}</li>
            </ul>
        {% endif %}
        {% if formset.errors %}
            <strong>Line Item Errors:</strong>
            <ul>
            {% for line_form in formset %}
                {% if line_form.errors %}
                    <li>Line {{ forloop.counter }}: {{ line_form.errors }}</li>
                {% endif %}
            {% endfor %}
            </ul>
        {% endif %}
    </div>
    {% endif %}

    <form method="post" id="form-form" enctype="multipart/form-data">
        {% csrf_token %}
        <!-- ✅ CRITICAL: Hidden input for tracking deleted attachments (placed at top for reliability) -->
        <input type="hidden" name="deleted_attachments" id="deleted-attachments" value="">

        <!-- Payment Form Information Card -->
        <div class="form-card">
            <div class="form-card-header">
                <h2 class="form-card-title">
                    <i class="bi bi-info-circle"></i>
                    <span>Payment Form Information</span>
                </h2>
            </div>
            <div class="form-card-body">
                {% if form.non_field_errors %}
                    <div class="alert alert-danger">
                        {{ form.non_field_errors }}
                    </div>
                {% endif %}

                <!-- ✅ 3-COLUMN GRID LAYOUT -->
                <!-- Row 1: PF Number, Payee Name, Payment Date -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="{{ form.pf_number.id_for_label }}" class="form-label">
                            {{ form.pf_number.label }}
                        </label>
                        {{ form.pf_number }}
                        {% if form.pf_number.errors %}
                            <small style="color: #dc3545;">{{ form.pf_number.errors|first }}</small>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="{{ form.payee_name.id_for_label }}" class="form-label">
                            {{ form.payee_name.label }} <span style="color: #dc2626;">*</span>
                        </label>
                        {{ form.payee_name }}
                        {% if form.payee_name.errors %}
                            <small style="color: #dc3545;">{{ form.payee_name.errors|first }}</small>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="{{ form.payment_date.id_for_label }}" class="form-label">
                            {{ form.payment_date.label }} <span style="color: #dc2626;">*</span>
                        </label>
                        {{ form.payment_date }}
                        {% if form.payment_date.errors %}
                            <small style="color: #dc3545;">{{ form.payment_date.errors|first }}</small>
                        {% endif %}
                    </div>
                </div>

                <!-- Row 2: Company Bank Account (Full width) -->
                <div class="form-row-full">
                    <div class="form-group">
                        <label class="form-label" for="{{ form.company_bank_account.id_for_label }}">
                            {{ form.company_bank_account.label }}
                        </label>
                        {{ form.company_bank_account }}
                        {% if form.company_bank_account.errors %}
                            <small style="color: var(--danger);">{{ form.company_bank_account.errors|first }}</small>
                        {% endif %}
                        <small class="form-text text-muted" style="font-size: 0.75rem; display: block; margin-top: 4px;">
                            <i class="bi bi-info-circle"></i> Select a pre-configured company account (recommended)
                        </small>
                    </div>
                </div>

                <!-- Row 3: Manual Bank Entry (Optional) - Collapsible -->
                <div class="form-row-full" style="margin-top: var(--spacing-md);">
                    <details style="border: 1px solid var(--gray-300); border-radius: var(--radius-md); padding: var(--spacing-sm);">
                        <summary style="cursor: pointer; font-weight: 600; color: var(--gray-700); font-size: 0.875rem; user-select: none;">
                            <i class="bi bi-pencil-square"></i> Manual Bank Entry (Optional - for backward compatibility)
                        </summary>
                        <div style="margin-top: var(--spacing-sm); padding-top: var(--spacing-sm); border-top: 1px solid var(--gray-200);">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="{{ form.bank_address.id_for_label }}" class="form-label">
                                        {{ form.bank_address.label }}
                                    </label>
                                    {{ form.bank_address }}
                                    {% if form.bank_address.errors %}
                                        <small style="color: #dc3545;">{{ form.bank_address.errors|first }}</small>
                                    {% endif %}
                                </div>

                                <div class="form-group">
                                    <label for="{{ form.bank_name.id_for_label }}" class="form-label">
                                        {{ form.bank_name.label }}
                                    </label>
                                    {{ form.bank_name }}
                                    {% if form.bank_name.errors %}
                                        <small style="color: #dc3545;">{{ form.bank_name.errors|first }}</small>
                                    {% endif %}
                                </div>

                                <div class="form-group">
                                    <label for="{{ form.bank_account_number.id_for_label }}" class="form-label">
                                        {{ form.bank_account_number.label }}
                                    </label>
                                    {{ form.bank_account_number }}
                                    {% if form.bank_account_number.errors %}
                                        <small style="color: #dc3545;">{{ form.bank_account_number.errors|first }}</small>
                                    {% endif %}
                                </div>
                            </div>
                            <small class="form-text text-muted" style="font-size: 0.75rem; display: block; margin-top: var(--spacing-xs);">
                                <i class="bi bi-exclamation-triangle"></i> Only use manual entry if the account is not in the dropdown above
                            </small>
                        </div>
                    </details>
                </div>

                <!-- Hidden Status Field -->
                {{ form.status }}

                <div class="helper-text" style="margin-top: var(--spacing-sm);">
                    <i class="bi bi-lightbulb"></i>
                    <span>Fill in all required fields before proceeding to line items.</span>
                </div>
            </div>
        </div>

        <!-- Line Items Card -->
        <div class="form-card">
            <div class="form-card-header info">
                <h2 class="form-card-title">
                    <i class="bi bi-list-check"></i>
                    <span>Line Items</span>
                </h2>
            </div>
            <div class="form-card-body">
                {% if formset.non_form_errors %}
                    <div class="alert alert-danger">
                        <strong>Line Items Error:</strong>
                        {{ formset.non_form_errors }}
                    </div>
                {% endif %}

                <div class="helper-text" style="margin-bottom: var(--spacing-md);">
                    <i class="bi bi-info-circle"></i>
                    <span>Fill in the table below with your payment form line items. At least one line item is required. Click "Add Line Item" button below to add more rows (up to 50).</span>
                </div>

                {{ formset.management_form }}

                <div class="line-items-table-container">
                    <table class="line-items-table" id="line-items-table">
                        <thead>
                            <tr>
                                <th style="width: 5%;">#</th>
                                <th style="width: 24%;">Description</th>
                                <th style="width: 12%;">Department</th>
                                <th style="width: 12%;">Program</th>
                                <th style="width: 10%;">Amount</th>
                                <th style="width: 8%;">Currency</th>
                                <th style="width: 9%;">VAT (10%)</th>
                                <th style="width: 11%;">Total</th>
                                <th style="width: 5%;">Action</th>
                            </tr>
                        </thead>
                        <tbody id="line-items-body">
                            {% for form in formset %}
                            <tr class="line-item-row" data-form-index="{{ forloop.counter0 }}">
                                <td class="text-center">
                                    <span class="line-number-badge">{{ forloop.counter }}</span>
                                    <!-- Hidden fields -->
                                    {{ form.line_number }}
                                    {{ form.id }}
                                    <div style="display: none;">{{ form.DELETE }}</div>
                                </td>
                                <td>
                                    {{ form.description }}
                                    {% if form.description.errors %}
                                        <small style="color: #dc3545;">{{ form.description.errors|first }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    {{ form.department }}
                                    {% if form.department.errors %}
                                        <small style="color: #dc3545;">{{ form.department.errors|first }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    {{ form.program }}
                                    {% if form.program.errors %}
                                        <small style="color: #dc3545;">{{ form.program.errors|first }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    {{ form.amount }}
                                    {% if form.amount.errors %}
                                        <small style="color: #dc3545;">{{ form.amount.errors|first }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    {{ form.currency }}
                                    {% if form.currency.errors %}
                                        <small style="color: #dc3545;">{{ form.currency.errors|first }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="vat-checkbox-container">
                                        {{ form.vat_applicable }}
                                    </div>
                                </td>
                                <td class="line-total">$0.00</td>
                                <td class="text-center">
                                    <button type="button" class="delete-line-btn" onclick="removeLineItem(this)" title="Remove this line">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr>
                                <th colspan="7" style="text-align: right;">GRAND TOTAL:</th>
                                <th>
                                    <div class="grand-total-value" id="grand-total">$0.00</div>
                                </th>
                                <th></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <button type="button" class="add-line-btn" onclick="addLineItem()">
                    <i class="bi bi-plus-circle"></i>
                    <span>Add Line Item</span>
                </button>

                <div class="helper-text" style="margin-top: var(--spacing-md);">
                    <i class="bi bi-info-circle"></i>
                    <span>Check the VAT box to add 10% tax to the line item amount. Click "Add Line Item" to add more rows.</span>
                </div>
            </div>
        </div>

        <!-- Attachments Card -->
        <div class="form-card">
            <div class="form-card-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-bottom-color: #fbbf24;">
                <h2 class="form-card-title">
                    <i class="bi bi-paperclip"></i>
                    <span>Attachments (Optional)</span>
                </h2>
            </div>
            <div class="form-card-body">
                {% if object and object.pf_number %}
                <div style="background: #d1fae5; border-left: 3px solid #10b981; padding: var(--spacing-sm); border-radius: var(--radius-sm); margin-bottom: var(--spacing-md); font-size: 0.8125rem; color: var(--gray-700);">
                    <i class="bi bi-folder2-open"></i> <strong>Storage Location:</strong> form_attachments/{{ object.pf_number }}/
                </div>
                {% endif %}

                <!-- Existing Attachments (for edit mode) -->
                {% if object %}
                    {% if object.attachments.exists %}
                        <div id="existing-attachments-container" style="background: var(--gray-50); border: 1px solid var(--gray-200); border-radius: var(--radius-md); padding: var(--spacing-md); margin-bottom: var(--spacing-lg);">
                            <h4 style="font-size: 0.875rem; font-weight: 600; color: var(--gray-700); margin-bottom: var(--spacing-sm); display: flex; align-items: center; gap: var(--spacing-xs);">
                                <i class="bi bi-folder-check"></i>
                                <span>Existing Attachments ({{ object.attachments.count }})</span>
                            </h4>
                            <ul class="files-list" id="existing-files-list">
                                {% for attachment in object.attachments.all %}
                                    <li data-attachment-id="{{ attachment.id }}">
                                        <div class="file-info">
                                            {% if '.pdf' in attachment.file.name|lower or '.PDF' in attachment.file.name %}
                                                <i class="bi bi-file-earmark-pdf file-icon"></i>
                                            {% elif '.jpg' in attachment.file.name|lower or '.jpeg' in attachment.file.name|lower or '.png' in attachment.file.name|lower %}
                                                <i class="bi bi-file-earmark-image file-icon"></i>
                                            {% else %}
                                                <i class="bi bi-file-earmark file-icon"></i>
                                            {% endif %}
                                            <a href="{{ attachment.file.url }}" target="_blank" class="file-name" style="text-decoration: none; color: var(--primary-600);">
                                                {{ attachment.filename }}
                                            </a>
                                            <span class="file-size">({{ attachment.file_size|filesizeformat }})</span>
                                        </div>
                                        <button type="button" class="remove-file-btn" onclick="removeExistingAttachment({{ attachment.id }}, '{{ attachment.filename|escapejs }}')">
                                            <i class="bi bi-x"></i> Remove
                                        </button>
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% else %}
                        <div id="existing-attachments-container" style="background: var(--gray-50); border: 1px dashed var(--gray-300); border-radius: var(--radius-md); padding: var(--spacing-md); margin-bottom: var(--spacing-lg); text-align: center; color: var(--gray-600); font-size: 0.875rem;">
                            <i class="bi bi-inbox"></i> No attachments found for this payment form.
                        </div>
                    {% endif %}
                {% endif %}

                <div class="helper-text" style="margin-bottom: var(--spacing-md);">
                    <i class="bi bi-info-circle"></i>
                    <span>Upload supporting documents such as invoices, receipts, or contracts. You can select multiple files at once.
                    {% if not object %}Files will be organized using a PF number that will be generated when you save this payment form.{% endif %}</span>
                </div>

                <!-- Upload Area - COMPACT -->
                <div class="attachment-upload-area">
                    <label for="id_attachments" class="attachment-upload-label" style="padding: var(--spacing-md); min-height: auto;">
                        <div style="display: flex; align-items: center; justify-content: center; gap: var(--spacing-sm);">
                            <i class="bi bi-cloud-upload" style="font-size: 1.5rem; color: #10b981;"></i>
                            <div style="text-align: left;">
                                <div class="upload-text" style="font-size: 0.875rem; margin-bottom: 2px;">
                                    <strong>Click to upload</strong> or drag and drop
                                </div>
                                <div class="upload-hint" style="font-size: 0.75rem;">
                                    PDF, JPG, PNG (Max 10MB per file)
                                </div>
                            </div>
                        </div>
                    </label>
                    <input type="file" name="attachments" id="id_attachments" class="attachment-input" multiple accept=".pdf,.jpg,.jpeg,.png" onchange="displaySelectedFiles(this)">
                </div>

                <!-- Selected New Files List -->
                <div id="selected-files-list" class="selected-files-list" style="display: none; padding: var(--spacing-sm); margin-top: var(--spacing-sm);">
                    <h4 style="font-size: 0.8125rem; font-weight: 600; color: var(--gray-700); margin-bottom: var(--spacing-xs);">
                        <i class="bi bi-files"></i> New Files:
                    </h4>
                    <ul id="files-list" class="files-list" style="gap: 4px;"></ul>
                </div>

                <div class="helper-text" style="margin-top: var(--spacing-sm);">
                    <i class="bi bi-shield-check"></i>
                    <span>Files are securely stored and only accessible to authorized users.</span>
                </div>
            </div>
        </div>

        <!-- Action Buttons Card -->
        <div class="form-card">
            <div class="form-card-body">
                <div class="action-buttons">
                    <button type="submit" class="save-btn">
                        <i class="bi bi-check-circle"></i>
                        <span>Save Payment Form</span>
                    </button>
                    <a href="{% if object %}{% url 'vouchers:pf_detail' object.pk %}{% else %}{% url 'dashboard:home' %}{% endif %}" class="cancel-btn">
                        <i class="bi bi-x-circle"></i>
                        <span>Cancel</span>
                    </a>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- ⚡ Loading Overlay for instant feedback -->
<div class="loading-overlay" id="loading-overlay">
    <div class="loading-spinner">
        <i class="bi bi-arrow-repeat"></i>
        <p>Processing...</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ✅ DECLARE THIS AT THE TOP - BEFORE ANY FUNCTIONS
let deletedAttachments = [];

// Same JavaScript as voucher_form.html but with 'line_items' formset prefix
function showNotification(message, type = 'info') {
    const iconMap = {
        success: 'bi-check-circle-fill',
        warning: 'bi-exclamation-triangle-fill',
        danger: 'bi-x-circle-fill',
        info: 'bi-info-circle-fill'
    };

    const toast = document.createElement('div');
    toast.className = `toast-notification ${type}`;
    toast.innerHTML = `
        <i class="bi ${iconMap[type] || iconMap.info}"></i>
        <span class="toast-message">${message}</span>
    `;

    document.body.appendChild(toast);

    setTimeout(() => {
        toast.classList.add('fadeOut');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

function calculateLineTotals() {
    const currencySymbols = {
        'USD': '$',
        'KHR': '៛',
        'THB': '฿'
    };

    // Track totals by currency
    const grandTotals = {};

    document.querySelectorAll('.line-item-row').forEach(row => {
        const amountInput = row.querySelector('[name$="-amount"]');
        const currencySelect = row.querySelector('[name$="-currency"]');
        const vatCheckbox = row.querySelector('[name$="-vat_applicable"]');
        const totalCell = row.querySelector('.line-total');

        if (amountInput && amountInput.value && currencySelect) {
            let amount = parseFloat(amountInput.value) || 0;
            let total = vatCheckbox && vatCheckbox.checked ? amount * 1.1 : amount;
            let currency = currencySelect.value || 'USD';
            let symbol = currencySymbols[currency] || '$';

            totalCell.textContent = symbol + total.toFixed(2);

            // Add to grand total for this currency
            if (!grandTotals[currency]) {
                grandTotals[currency] = 0;
            }
            grandTotals[currency] += total;
        } else {
            totalCell.textContent = '$0.00';
        }
    });

    // Display multi-currency grand total
    const grandTotalElement = document.getElementById('grand-total');
    const parts = [];

    // Sort currencies for consistent display
    const currencies = Object.keys(grandTotals).sort();

    if (currencies.length === 0) {
        grandTotalElement.textContent = '$0.00';
    } else {
        currencies.forEach(currency => {
            const symbol = currencySymbols[currency] || currency;
            const amount = grandTotals[currency];
            parts.push(`${symbol}${amount.toFixed(2)}`);
        });
        grandTotalElement.textContent = parts.join(' + ');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    calculateLineTotals();

    document.querySelectorAll('[name$="-amount"], [name$="-currency"], [name$="-vat_applicable"]').forEach(el => {
        el.addEventListener('change', calculateLineTotals);
        el.addEventListener('input', calculateLineTotals);
    });

    document.querySelectorAll('[name$="-vat_applicable"]').forEach(checkbox => {
        checkbox.classList.add('vat-checkbox');
    });

    const form = document.getElementById('form-form');
    const submitBtn = form.querySelector('.save-btn');

    form.addEventListener('submit', function(e) {
        // ⚡ OPTIMIZED: Quick validation only, no heavy processing
        const hiddenInput = document.getElementById('deleted-attachments');

        // Critical validation - must exist
        if (!hiddenInput) {
            e.preventDefault();
            alert('Form error: Please refresh and try again.');
            return false;
        }

        // Show loading overlay INSTANTLY for immediate feedback
        const loadingOverlay = document.getElementById('loading-overlay');
        if (loadingOverlay) {
            loadingOverlay.classList.add('active');
        }

        // Show submitting state on button
        submitBtn.classList.add('submitting');
        submitBtn.disabled = true;

        // Optional: Log for debugging (doesn't block submission)
        console.log('Form submitting...');
    });
});

function addLineItem() {
    const tbody = document.getElementById('line-items-body');
    const totalFormsInput = document.querySelector('input[name$="TOTAL_FORMS"]');
    const maxFormsInput = document.querySelector('input[name$="MAX_NUM_FORMS"]');

    let totalForms = parseInt(totalFormsInput.value);
    const maxForms = parseInt(maxFormsInput.value);

    if (totalForms >= maxForms) {
        showNotification('Maximum number of line items reached (50).', 'warning');
        return;
    }

    const firstRow = tbody.querySelector('.line-item-row');
    if (!firstRow) {
        showNotification('Error: No template row found.', 'danger');
        return;
    }

    const newRow = firstRow.cloneNode(true);
    const newIndex = totalForms;

    const badge = newRow.querySelector('.line-number-badge');
    badge.textContent = newIndex + 1;

    const fields = newRow.querySelectorAll('input, select, textarea');
    fields.forEach(field => {
        if (field.name) {
            field.name = field.name.replace(/line_items-\d+-/, `line_items-${newIndex}-`);
        }
        if (field.id) {
            field.id = field.id.replace(/id_line_items-\d+-/, `id_line_items-${newIndex}-`);
        }

        if (field.type !== 'hidden') {
            if (field.type === 'checkbox') {
                field.checked = false;
            } else {
                field.value = '';
            }
        }

        if (field.name && field.name.includes('line_number')) {
            field.value = '';
        }
    });

    const errorMessages = newRow.querySelectorAll('small[style*="color"]');
    errorMessages.forEach(msg => msg.remove());

    const totalCell = newRow.querySelector('.line-total');
    if (totalCell) {
        totalCell.textContent = '$0.00';
    }

    tbody.appendChild(newRow);
    totalFormsInput.value = totalForms + 1;

    const newAmountInput = newRow.querySelector('[name$="-amount"]');
    const newCurrencySelect = newRow.querySelector('[name$="-currency"]');
    const newVatCheckbox = newRow.querySelector('[name$="-vat_applicable"]');
    if (newAmountInput) {
        newAmountInput.addEventListener('change', calculateLineTotals);
        newAmountInput.addEventListener('input', calculateLineTotals);
    }
    if (newCurrencySelect) {
        newCurrencySelect.addEventListener('change', calculateLineTotals);
    }
    if (newVatCheckbox) {
        newVatCheckbox.addEventListener('change', calculateLineTotals);
        newVatCheckbox.classList.add('vat-checkbox');
    }

    newRow.scrollIntoView({ behavior: 'smooth', block: 'center' });

    const descField = newRow.querySelector('[name$="-description"]');
    if (descField) {
        setTimeout(() => descField.focus(), 300);
    }

    showNotification(`Line item ${newIndex + 1} added successfully!`, 'success');
    console.log(`Added line item ${newIndex + 1}. Total forms: ${totalForms + 1}`);
}

function removeLineItem(button) {
    const tbody = document.getElementById('line-items-body');
    const rows = tbody.querySelectorAll('.line-item-row:not([data-deleted="true"])');

    // Don't allow removing if only one visible row left
    if (rows.length <= 1) {
        showNotification('You must have at least one line item.', 'warning');
        return;
    }

    // Get the row to remove
    const row = button.closest('.line-item-row');

    // ✅ FIX: Check if this is an EXISTING item (has an ID) or NEW item
    const idInput = row.querySelector('input[name$="-id"]');
    const hasId = idInput && idInput.value;

    if (hasId) {
        // EXISTING item: Mark for deletion and hide (keep in DOM for Django formset)
        const deleteCheckbox = row.querySelector('input[name$="-DELETE"]');
        if (deleteCheckbox) {
            deleteCheckbox.checked = true;
        }

        // Mark as deleted and hide
        row.setAttribute('data-deleted', 'true');
        row.style.opacity = '0';
        row.style.transform = 'translateX(-20px)';

        setTimeout(() => {
            row.style.display = 'none';

            // Renumber remaining visible rows
            renumberRows();

            // Recalculate totals
            calculateLineTotals();

            showNotification('Line item marked for deletion.', 'success');
            console.log(`Existing line item (ID: ${idInput.value}) marked for deletion`);
        }, 200);
    } else {
        // NEW item: Safe to remove from DOM completely
        row.style.opacity = '0';
        row.style.transform = 'translateX(-20px)';

        setTimeout(() => {
            row.remove();

            // Update TOTAL_FORMS count (only for new items being removed)
            const totalFormsInput = document.querySelector('input[name$="TOTAL_FORMS"]');
            totalFormsInput.value = parseInt(totalFormsInput.value) - 1;

            // Renumber remaining rows
            renumberRows();

            // Recalculate totals
            calculateLineTotals();

            showNotification('Line item removed successfully.', 'success');
            console.log('New line item removed from DOM. Total forms:', totalFormsInput.value);
        }, 200);
    }
}

function renumberRows() {
    // ✅ FIX: Only renumber visible rows (skip deleted rows)
    const allRows = document.querySelectorAll('.line-item-row');
    const visibleRows = Array.from(allRows).filter(row => !row.hasAttribute('data-deleted'));

    // Renumber only visible rows
    visibleRows.forEach((row, index) => {
        // Update the badge number (1-based for display)
        const badge = row.querySelector('.line-number-badge');
        if (badge) {
            badge.textContent = index + 1;
        }
    });

    // Renumber ALL rows (including deleted) for proper formset indexing
    allRows.forEach((row, index) => {
        // Update form field names and IDs
        const fields = row.querySelectorAll('input, select, textarea');
        fields.forEach(field => {
            if (field.name) {
                field.name = field.name.replace(/line_items-\d+-/, `line_items-${index}-`);
            }
            if (field.id) {
                field.id = field.id.replace(/id_line_items-\d+-/, `id_line_items-${index}-`);
            }
        });
    });

    console.log(`Renumbered: ${visibleRows.length} visible rows, ${allRows.length} total rows (including deleted)`);
}

function displaySelectedFiles(input) {
    const filesList = document.getElementById('files-list');
    const selectedFilesDiv = document.getElementById('selected-files-list');

    filesList.innerHTML = '';

    if (input.files.length === 0) {
        selectedFilesDiv.style.display = 'none';
        return;
    }

    selectedFilesDiv.style.display = 'block';

    const dataTransfer = new DataTransfer();

    Array.from(input.files).forEach((file, index) => {
        dataTransfer.items.add(file);

        const li = document.createElement('li');

        const fileInfo = document.createElement('div');
        fileInfo.className = 'file-info';

        const icon = document.createElement('i');
        icon.className = 'bi bi-file-earmark-pdf file-icon';
        if (file.type.startsWith('image/')) {
            icon.className = 'bi bi-file-earmark-image file-icon';
        }

        const fileName = document.createElement('span');
        fileName.className = 'file-name';
        fileName.textContent = file.name;

        const fileSize = document.createElement('span');
        fileSize.className = 'file-size';
        fileSize.textContent = `(${(file.size / 1024).toFixed(1)} KB)`;

        fileInfo.appendChild(icon);
        fileInfo.appendChild(fileName);
        fileInfo.appendChild(fileSize);

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'remove-file-btn';
        removeBtn.innerHTML = '<i class="bi bi-x"></i> Remove';
        removeBtn.onclick = function() {
            removeFile(index, input);
        };

        li.appendChild(fileInfo);
        li.appendChild(removeBtn);
        filesList.appendChild(li);
    });

    input.files = dataTransfer.files;
}

function removeFile(index, input) {
    const dataTransfer = new DataTransfer();

    Array.from(input.files).forEach((file, i) => {
        if (i !== index) {
            dataTransfer.items.add(file);
        }
    });

    input.files = dataTransfer.files;
    displaySelectedFiles(input);

    showNotification('File removed successfully.', 'success');
}

// ✅ FIXED: Remove existing attachment with defensive validation
function removeExistingAttachment(attachmentId, fileName) {
    // ✅ FIX: Defensive check - ensure hidden input exists
    const hiddenInput = document.getElementById('deleted-attachments');
    if (!hiddenInput) {
        console.error('❌ CRITICAL: Hidden input disappeared! Cannot track deletions.');
        alert('Critical error: Unable to track deleted attachments. Please refresh the page and try again.');
        return;
    }

    console.log('=== REMOVING ATTACHMENT ===');
    console.log('Attachment ID:', attachmentId);
    console.log('Before - deletedAttachments array:', deletedAttachments);

    // Add to deleted list
    deletedAttachments.push(attachmentId);

    // Update hidden input with comma-separated IDs
    hiddenInput.value = deletedAttachments.join(',');

    // Verify update succeeded
    if (hiddenInput.value === deletedAttachments.join(',')) {
        console.log('✅ After - deletedAttachments array:', deletedAttachments);
        console.log('✅ Hidden input value:', hiddenInput.value);
    } else {
        console.error('❌ Hidden input value mismatch!');
        console.error('Expected:', deletedAttachments.join(','));
        console.error('Actual:', hiddenInput.value);
    }
    console.log('============================');

    // Remove from UI
    const listItem = document.querySelector(`li[data-attachment-id="${attachmentId}"]`);
    if (listItem) {
        listItem.style.opacity = '0';
        listItem.style.transform = 'translateX(-20px)';

        setTimeout(() => {
            listItem.remove();

            // Check if list is empty
            const existingFilesList = document.getElementById('existing-files-list');
            if (existingFilesList && existingFilesList.children.length === 0) {
                const container = document.getElementById('existing-attachments-container');
                if (container) {
                    container.innerHTML = `
                        <div style="background: var(--gray-50); border: 1px dashed var(--gray-300); border-radius: var(--radius-md); padding: var(--spacing-md); text-align: center; color: var(--gray-600); font-size: 0.875rem;">
                            <i class="bi bi-inbox"></i> All attachments removed. They will be deleted when you save.
                        </div>
                    `;
                }
            }

            showNotification(`"${fileName}" will be deleted when you save the payment form.`, 'warning');
        }, 200);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const uploadLabel = document.querySelector('.attachment-upload-label');
    const fileInput = document.getElementById('id_attachments');

    if (!uploadLabel || !fileInput) return;

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadLabel.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        uploadLabel.addEventListener(eventName, () => {
            uploadLabel.style.borderColor = '#10b981';
            uploadLabel.style.background = '#a7f3d0';
        }, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        uploadLabel.addEventListener(eventName, () => {
            uploadLabel.style.borderColor = '#34d399';
            uploadLabel.style.background = '#d1fae5';
        }, false);
    });

    uploadLabel.addEventListener('drop', function(e) {
        const dt = e.dataTransfer;
        const files = dt.files;

        fileInput.files = files;
        displaySelectedFiles(fileInput);

        if (files.length > 0) {
            showNotification(`${files.length} file(s) selected successfully.`, 'success');
        }
    }, false);
});
</script>
{% endblock %}